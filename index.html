<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MyBrowser</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --surface:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:#dbeafe;
      --border:#e5e7eb;
      --shadow:0 10px 24px rgba(15,23,42,.15);
      --surface-dark:#0f172a;
      --panel-dark:#111827;
      --text-dark:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#f8fafc 0%,#eef2ff 100%);color:#111827;line-height:1.45}
    body.dark{
      background:linear-gradient(180deg,#0b1020 0%,#0f172a 100%);
      color:var(--text-dark);
    }
    body.dark #tabs{background:rgba(15,23,42,.85);border-bottom-color:#1f2937}
    body.dark .tab{background:#0f172a;border-color:#1f2937;color:var(--text-dark)}
    body.dark .tab.active{background:#1e293b;border-color:#334155}
    body.dark #bmbar{background:#0b1220;border-bottom-color:#1f2937}
    body.dark .bmitem{background:#0f172a;border-color:#1f2937;color:var(--text-dark)}
    body.dark .bmitem:hover{background:#111827}
    body.dark .panel{background:var(--panel-dark);border-color:#1f2937;color:var(--text-dark)}
    body.dark .row input,body.dark .row select{background:#0b1220;border-color:#1f2937;color:var(--text-dark)}
    body.dark button{background:#0f172a;border-color:#1f2937;color:var(--text-dark)}
    body.dark button:hover{background:#111827}
    body.dark #url{background:rgba(15,23,42,.85);color:var(--text-dark)}
    body.dark #url::placeholder{color:#94a3b8}
    #top{
      display:flex;flex-wrap:wrap;gap:10px;padding:10px 14px;
      background:linear-gradient(135deg,#0f172a,#1e293b);
      align-items:center;border-bottom:1px solid #0f172a;color:#f8fafc;
      position:sticky;top:0;z-index:10;box-shadow:0 10px 20px rgba(15,23,42,.22)
    }
    .toolbar-group{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.08);padding:6px;border-radius:14px}
    .toolbar-group.primary{flex:1;min-width:260px}
    #tabs{display:flex;gap:6px;padding:8px 10px;background:rgba(255,255,255,.7);backdrop-filter:blur(6px);overflow:auto;border-bottom:1px solid var(--border)}
    .tab{
      padding:6px 12px;background:#fff;border:1px solid var(--border);border-radius:999px;cursor:pointer;
      display:flex;gap:8px;align-items:center;white-space:nowrap;box-shadow:0 6px 14px rgba(15,23,42,.08);
      transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease
    }
    .tab:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(15,23,42,.12)}
    .tab.active{background:var(--accent-soft);border-color:#93c5fd;box-shadow:0 12px 20px rgba(59,130,246,.25)}
    .tab small{opacity:.75;font-family:ui-monospace,Menlo,monospace}
    .tab .x{border:none;background:transparent;cursor:pointer;font-size:14px;padding:0 4px;opacity:.7}
    .tab .x:hover{opacity:1}

    #url{
      flex:1;padding:10px 14px;border:1px solid transparent;border-radius:999px;
      background:rgba(255,255,255,.92);outline:none;color:#0f172a;transition:border-color .15s ease,box-shadow .15s ease
    }
    #url:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(59,130,246,.3)}
    #url::placeholder{color:#94a3b8}
    button{
      padding:7px 12px;border:1px solid rgba(148,163,184,.6);border-radius:12px;
      cursor:pointer;background:#fff;color:#0f172a;font-weight:600;box-shadow:0 4px 10px rgba(15,23,42,.08);
      display:inline-flex;align-items:center;justify-content:center;gap:6px;line-height:1;min-height:32px;
      transition:transform .15s ease,box-shadow .15s ease,background .15s ease
    }
    button:hover{background:#f1f5f9;transform:translateY(-1px);box-shadow:0 8px 14px rgba(15,23,42,.12)}
    button:focus-visible,#url:focus-visible{outline:2px solid rgba(59,130,246,.65);outline-offset:2px}
    button:active{transform:translateY(0);box-shadow:0 4px 10px rgba(15,23,42,.08)}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button.primary:hover{background:#1d4ed8}
    button.icon{width:34px;min-width:34px;padding:0}
    .mini{padding:6px 10px;border-radius:10px;font-size:12px;min-height:28px}

    #bmbar{
      display:flex; gap:8px; align-items:center;
      padding:8px 12px; background:#fff; border-bottom:1px solid var(--border);
      overflow:auto; white-space:nowrap; box-shadow:0 6px 14px rgba(15,23,42,.06)
    }
    .bmitem{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px;
      background:#fff; cursor:pointer;
      font-size:13px;
    }
    .bmitem:hover{background:#f3f4f6}
    .bmitem .del{border:none;background:transparent;cursor:pointer;opacity:.6}
    .bmitem .del:hover{opacity:1}

    #views{width:100vw;height:calc(100vh - 142px);position:relative;background:#0b1220}
    #views::before{
      content:"Loading tab...";
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      color:#cbd5f5;
      font-size:12px;
      letter-spacing:.04em;
    }

    .panel{
      display:none; position:fixed; top:72px; right:14px; width:400px;
      background:#fff; border:1px solid var(--border); box-shadow:var(--shadow);
      padding:14px; border-radius:16px; z-index:99999;
      max-height: 80vh; overflow:auto; animation:fadeIn .18s ease;
    }
    #geoPanel{
      position:fixed; top:72px; left:14px; width:320px;
      background:#fff; border:1px solid var(--border); box-shadow:var(--shadow);
      padding:14px; border-radius:16px; z-index:99998;
      max-height: 80vh; overflow:auto;
    }
    body.dark #geoPanel{background:var(--panel-dark);border-color:#1f2937;color:var(--text-dark)}
    #geoPanel h3{margin:0 0 8px 0;font-size:14px;}
    #geoList{display:flex;flex-direction:column;gap:10px;}
    .geo-card{border:1px solid var(--border);border-radius:12px;padding:10px;background:#f8fafc}
    body.dark .geo-card{background:#0b1220;border-color:#1f2937}
    .geo-card .title{font-weight:700;margin-bottom:6px;font-size:13px;}
    .geo-grid{display:grid;grid-template-columns:1fr;gap:4px;font-size:12px;}
    .geo-section{margin-top:8px;}
    .geo-section-title{font-weight:700;font-size:12px;margin-bottom:4px;}
    .geo-pre{white-space:pre-wrap;background:#fff;border:1px dashed var(--border);border-radius:10px;padding:8px;font-size:11px;margin:6px 0 0 0;}
    body.dark .geo-pre{background:#0f172a;border-color:#1f2937}
    details.geo-raw{margin-top:6px;}
    .geo-label{color:var(--muted)}
    @keyframes fadeIn{from{opacity:.7;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    .panel h3{margin:0 0 10px 0; font-size:14px;}
    .row{display:flex; gap:8px; align-items:center;}
    .row input,.row select{flex:1;padding:8px;border:1px solid #cbd5f5;border-radius:10px;}
    .row label{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:#eee;margin:10px 0;}

    .item{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;}
    .item .name{font-weight:700}
    .muted{opacity:.75;font-size:12px; word-break:break-all}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px;}
    .badge{padding:4px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;font-size:11px;font-weight:700}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid transparent}
    .status.ok{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .status.error{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .status.wait{background:#e0f2fe;color:#0c4a6e;border-color:#bae6fd}
  </style>
</head>
<body>

<div id="top">
  <div class="toolbar-group">
    <button id="back" class="icon">‚Üê</button>
    <button id="forward" class="icon">‚Üí</button>
    <button id="reload" class="icon">‚ü≥</button>
  </div>

  <div class="toolbar-group primary">
    <button id="home" class="mini">Home</button>
    <input id="url" placeholder="Search or enter address"/>
    <button id="go" class="primary">Go</button>
  </div>

  <div class="toolbar-group">
    <button id="newtab" class="icon">Ôºã</button>
    <button id="newIncog" class="icon">üï∂Ô∏è</button>
  </div>

  <div class="toolbar-group">
    <button id="devtools">Dev</button>
    <button id="proxyBtn">Proxy</button>
    <button id="uaBtn">User-Agent</button>
    <button id="extBtn">Extensions</button>
    <button id="bmBtn">Bookmarks</button>
    <button id="histBtn">History</button>
    <button id="settingsBtn">Settings</button>
  </div>
</div>

<div id="bmbar"></div>
<div id="tabs"></div>
<div id="views"></div>

<div id="geoPanel">
  <h3>IP / Nominatim</h3>
  <div id="geoList" class="muted">No data yet.</div>
</div>

<div id="proxyPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>Proxy Settings</h3>
    <button id="proxyClose" class="mini">‚úï</button>
  </div>

  <label><input type="checkbox" id="p_enabled"> Enabled</label>
  <div class="hr"></div>

  <div class="row">
    <select id="p_scheme">
      <option value="http">HTTP</option>
      <option value="https">HTTPS</option>
      <option value="socks4">SOCKS4</option>
      <option value="socks5">SOCKS5</option>
      <option value="socks5h">SOCKS5 (DNS over proxy)</option>
    </select>
  </div><br>
  <div class="row"><input id="p_host" placeholder="host (e.g. 127.0.0.1)"></div><br>
  <div class="row"><input id="p_port" placeholder="port (e.g. 1080)"></div><br>
  <div class="row"><input id="p_user" placeholder="username (optional)"></div><br>
  <div class="row"><input id="p_pass" placeholder="password (optional)" type="password"></div><br>
  <div class="row"><input id="p_bypass" placeholder="bypass rules (e.g. <-loopback>)"></div><br>

  <button id="proxyApply" style="width:100%;">Apply & Save (reload active tab)</button>
  <div class="row" style="justify-content:space-between;align-items:center;margin-top:10px;">
    <button id="proxyTest" class="mini">Test Proxy</button>
    <span id="proxyStatus" class="status wait">Not tested</span>
  </div>
  <div id="proxyDetails" class="muted" style="margin-top:6px;"></div>
  <p class="muted">Settings are auto-saved to config.json.</p>
</div>

<div id="uaPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>User-Agent</h3>
    <button id="uaClose" class="mini">‚úï</button>
  </div>

  <div class="row">
    <label style="min-width:80px;">Mode</label>
    <select id="ua_mode">
      <option value="preset">Preset</option>
      <option value="custom">Custom</option>
    </select>
  </div><br>

  <div class="row">
    <label style="min-width:80px;">Preset</label>
    <select id="ua_preset"></select>
  </div><br>

  <div class="row">
    <label style="min-width:80px;">Custom</label>
    <input id="ua_custom" placeholder="Paste custom UA string">
  </div><br>

  <div class="row">
    <label style="min-width:80px;">Add-on</label>
    <input id="ua_suffix" placeholder="Optional suffix (e.g. MyBrowser/1.0)">
  </div>

  <div class="hr"></div>
  <button id="uaApply" style="width:100%;">Apply to tabs (reload active tab)</button>
  <p class="muted">Choose a preset or custom UA, then optionally append a suffix for add-ons.</p>
</div>

<div id="extPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>Extensions Manager</h3>
    <button id="extClose" class="mini">‚úï</button>
  </div>

  <div class="row" style="justify-content:space-between;">
    <button id="extAdd" class="mini">Ôºã Add (Folder)</button>
    <button id="extRefresh" class="mini">‚ü≥ Refresh</button>
  </div>

  <div class="hr"></div>
  <div id="extList"></div>
  <p class="muted">Some Chrome extensions may not fully work in Electron.</p>
</div>

<div id="bmPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>Bookmarks</h3>
    <button id="bmClose" class="mini">‚úï</button>
  </div>

  <div class="row" style="justify-content:space-between;">
    <button id="bmAddCurrent" class="mini">‚òÖ Add current</button>
    <button id="bmRefresh" class="mini">‚ü≥ Refresh</button>
  </div>

  <div class="hr"></div>
  <div id="bmList"></div>
</div>

<div id="histPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>History</h3>
    <button id="histClose" class="mini">‚úï</button>
  </div>

  <div class="row" style="justify-content:space-between;">
    <button id="histClear" class="mini">üóëÔ∏è Clear</button>
    <button id="histRefresh" class="mini">‚ü≥ Refresh</button>
  </div>

  <div class="hr"></div>
  <div id="histList"></div>
</div>

<div id="settingsPanel" class="panel">
  <div class="row" style="justify-content:space-between;">
    <h3>Browser Settings</h3>
    <button id="settingsClose" class="mini">‚úï</button>
  </div>

  <div class="row">
    <label style="min-width:120px;">Home URL</label>
    <input id="s_home" placeholder="https://duckduckgo.com">
  </div><br>

  <div class="row">
    <label style="min-width:120px;">Search engine</label>
    <select id="s_search">
      <option value="duckduckgo">DuckDuckGo</option>
      <option value="google">Google</option>
      <option value="bing">Bing</option>
    </select>
  </div><br>

  <div class="row">
    <label style="min-width:120px;">Theme</label>
    <select id="s_theme">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
  </div>

  <div class="hr"></div>
  <button id="settingsApply" style="width:100%;">Save settings</button>
  <p class="muted">Settings update the home page, search engine, and theme.</p>
</div>

<script>
  const tabsEl = document.getElementById("tabs");
  const viewsEl = document.getElementById("views");
  const bmbarEl = document.getElementById("bmbar");
  const urlInput = document.getElementById("url");
  const FALLBACK_CONFIG = {
    proxy: {
      enabled: false,
      scheme: "socks5",
      host: "127.0.0.1",
      port: 1080,
      username: "",
      password: "",
      bypass: "<-loopback>"
    },
    userAgent: {
      mode: "preset",
      preset: "chrome-win",
      custom: "",
      suffix: ""
    },
    settings: {
      homeUrl: "https://duckduckgo.com",
      searchEngine: "duckduckgo",
      theme: "light"
    },
    extensions: [],
    bookmarks: [],
    history: [],
    historyLimit: 500
  };

  window.AutoIP = window.AutoIP || {
    getIpForTab: async () => ({ ip: "" }),
    getMainIp: async () => ({ ip: "" })
  };
  window.GeoAPI = window.GeoAPI || {
    enrichIp: async () => ({ ok: false, error: "Geo service unavailable." })
  };
  window.CfgAPI = window.CfgAPI || {
    get: async () => FALLBACK_CONFIG,
    set: async () => ({ ok: false })
  };
  window.ProxyCtl = window.ProxyCtl || {
    set: async () => ({ ok: false }),
    test: async () => ({ ok: false })
  };
  window.UA = window.UA || {
    set: async () => ({ ok: false })
  };
  window.ExtAPI = window.ExtAPI || {
    pickFolder: async () => null,
    list: async () => ({ extensions: [] }),
    add: async () => ({ ok: false }),
    toggle: async () => ({ ok: false }),
    remove: async () => ({ ok: false })
  };
  window.BM = window.BM || {
    list: async () => ({ bookmarks: [] }),
    add: async () => ({ ok: false }),
    remove: async () => ({ ok: false })
  };
  window.HIST = window.HIST || {
    list: async () => ({ history: [] }),
    add: async () => ({ ok: false }),
    clear: async () => ({ ok: false })
  };
  window.TabAPI = window.TabAPI || {
    create: async () => ({ ok: false }),
    switch: async () => ({ ok: false }),
    close: async () => ({ ok: false }),
    navigate: async () => ({ ok: false }),
    back: async () => ({ ok: false }),
    forward: async () => ({ ok: false }),
    reload: async () => ({ ok: false }),
    devtools: async () => ({ ok: false }),
    setIp: async () => ({ ok: false }),
    resize: async () => ({ ok: false }),
    onUpdate: () => {}
  };

  const USER_AGENT_PRESETS = {
    "chrome-win": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36",
    "chrome-mac": "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36",
    "chrome-linux": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36",
    "firefox-win": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:128.0) Gecko/20100101 Firefox/128.0",
    "firefox-mac": "Mozilla/5.0 (Macintosh; Intel Mac OS X 13.6; rv:128.0) Gecko/20100101 Firefox/128.0",
    "safari-mac": "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.4 Safari/605.1.15",
    "edge-win": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36 Edg/126.0.0.0"
  };
  let UA_CONFIG = { mode: "preset", preset: "chrome-win", custom: "", suffix: "" };
  let SETTINGS_CONFIG = { homeUrl: "https://duckduckgo.com", searchEngine: "duckduckgo", theme: "light" };

  // ===== IP/Geo list in console =====
  window.__IP_GEO_LOG__ = window.__IP_GEO_LOG__ || [];
  const geoPanel = document.getElementById("geoPanel");
  const geoList = document.getElementById("geoList");
  function logIpGeo(entry){
    window.__IP_GEO_LOG__.unshift(entry);
    console.clear();
    console.log("‚úÖ IP/Geo Log list (latest first):");
    console.table(window.__IP_GEO_LOG__.map(x => ({
      ts: new Date(x.ts).toLocaleString(),
      tabId: x.tabId,
      ip: x.ip,
      lat: x.geo?.latitude ?? "",
      lon: x.geo?.longitude ?? "",
      city: x.geo?.city ?? "",
      region: x.geo?.region ?? "",
      country: x.geo?.country ?? "",
      address: x.nominatim?.display_name ?? (x.nominatim?.error ?? x.error ?? "")
    })));
    renderGeoPanel();
  }

  function escapeHtml(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function formatValue(value){
    if (value == null) return "";
    if (typeof value === "string" || typeof value === "number" || typeof value === "boolean") {
      return String(value);
    }
    try {
      return JSON.stringify(value);
    } catch {
      return String(value);
    }
  }

  function renderKeyValueGrid(obj){
    if (!obj || typeof obj !== "object") {
      return `<div class="muted">No data</div>`;
    }
    const entries = Object.entries(obj);
    if (!entries.length) return `<div class="muted">No data</div>`;
    return entries.map(([key, value]) => (
      `<div><span class="geo-label">${escapeHtml(key)}:</span> ${escapeHtml(formatValue(value))}</div>`
    )).join("");
  }

  function renderGeoPanel(){
    if (!geoList) return;
    const entries = window.__IP_GEO_LOG__ || [];
    if (!entries.length) {
      geoList.className = "muted";
      geoList.textContent = "No data yet.";
      return;
    }
    geoList.className = "";
    geoList.innerHTML = entries.map(entry => {
      const ts = entry.ts ? new Date(entry.ts).toLocaleString() : "";
      const address = entry.nominatim?.display_name ?? (entry.nominatim?.error ?? entry.error ?? "");
      const nominatimRaw = entry.nominatim_raw || entry.nominatim?.raw || null;
      const geoRaw = entry.geo_raw || null;
      const nominatimRawText = nominatimRaw ? JSON.stringify(nominatimRaw, null, 2) : "";
      const geoRawText = geoRaw ? JSON.stringify(geoRaw, null, 2) : "";
      return `
        <div class="geo-card">
          <div class="title">Tab ${escapeHtml(entry.tabId)} ¬∑ ${escapeHtml(ts)}</div>
          <div class="geo-grid">
            <div><span class="geo-label">IP:</span> ${escapeHtml(entry.ip)}</div>
            <div><span class="geo-label">Lat/Lon:</span> ${escapeHtml(entry.geo?.latitude ?? "")} / ${escapeHtml(entry.geo?.longitude ?? "")}</div>
            <div><span class="geo-label">City:</span> ${escapeHtml(entry.geo?.city ?? "")}</div>
            <div><span class="geo-label">Region:</span> ${escapeHtml(entry.geo?.region ?? "")}</div>
            <div><span class="geo-label">Country:</span> ${escapeHtml(entry.geo?.country ?? "")}</div>
            <div><span class="geo-label">Address:</span> ${escapeHtml(address)}</div>
          </div>
          <div class="geo-section">
            <div class="geo-section-title">GeoLite2 Details</div>
            <div class="geo-grid">${renderKeyValueGrid(entry.geo)}</div>
            ${geoRawText ? `
              <details class="geo-raw">
                <summary class="geo-label">Raw GeoLite2 data</summary>
                <pre class="geo-pre">${escapeHtml(geoRawText)}</pre>
              </details>
            ` : ""}
          </div>
          <div class="geo-section">
            <div class="geo-section-title">Nominatim Details</div>
            <div class="geo-grid">${renderKeyValueGrid(entry.nominatim)}</div>
            ${nominatimRawText ? `
              <details class="geo-raw">
                <summary class="geo-label">Raw Nominatim data</summary>
                <pre class="geo-pre">${escapeHtml(nominatimRawText)}</pre>
              </details>
            ` : ""}
          </div>
        </div>
      `;
    }).join("");
  }

  async function fetchMainBrowserIp(){
    let info = null;
    try {
      info = await window.AutoIP.getMainIp();
    } catch (e) {
      info = { ok: false, error: String(e?.message || e) };
    }
    if (!info?.ip) {
      logIpGeo({ ts: Date.now(), tabId: "main", ip: "", ...info });
      return;
    }

    let enriched = null;
    try {
      enriched = await window.GeoAPI.enrichIp(info.ip);
    } catch (e) {
      enriched = { ok: false, error: String(e?.message || e) };
    }

    const entry = { ts: Date.now(), tabId: "main", ip: info.ip, ...enriched };
    logIpGeo(entry);
  }

  function searchUrlForQuery(query){
    const encoded = encodeURIComponent(query);
    const engine = SETTINGS_CONFIG.searchEngine || "duckduckgo";
    if (engine === "google") return `https://www.google.com/search?q=${encoded}`;
    if (engine === "bing") return `https://www.bing.com/search?q=${encoded}`;
    return `https://duckduckgo.com/?q=${encoded}`;
  }

  function normalizeUrl(input){
    let u = (input || "").trim();
    if(!u) return "";
    if(!u.startsWith("http://") && !u.startsWith("https://")){
      if (u.includes(" ")) return searchUrlForQuery(u);
      u = "https://" + u;
    }
    return u;
  }

  function getHomeUrl(){
    return SETTINGS_CONFIG.homeUrl || "https://duckduckgo.com";
  }

  function generateFingerprintHash(){
    const bytes = new Uint8Array(16);
    if (window.crypto?.getRandomValues) {
      window.crypto.getRandomValues(bytes);
    } else {
      for (let i = 0; i < bytes.length; i += 1) {
        bytes[i] = Math.floor(Math.random() * 256);
      }
    }
    return `fp_${Array.from(bytes).map((b) => b.toString(16).padStart(2, "0")).join("")}`;
  }

  window.FINGERPRINTHASH = generateFingerprintHash();
  window.HTTP2_FINGERPRINT = "1:65536;2:0;4:6291456;6:262144|15663105|0|m,a,s,p";
  window.AKAMAI_FINGERPRINT = "1:65536;2:0;4:6291456;6:262144|15663105|0|m,a,s,p";
  window.AKAMAI_HASH = "52d84b11737d980aef856699f885ca86";

  function buildUserAgent(cfg){
    const mode = cfg?.mode === "custom" ? "custom" : "preset";
    const preset = USER_AGENT_PRESETS[cfg?.preset] || USER_AGENT_PRESETS["chrome-win"];
    const base = mode === "custom" && cfg?.custom ? String(cfg.custom) : preset;
    const suffix = String(cfg?.suffix || "").trim();
    return suffix ? `${base} ${suffix}` : base;
  }

  function getActiveTab(){ return tabs.find(t => t.id === activeId) || null; }

  function loadUrlInView(tabId, url){
    if (!tabId || !url) return;
    window.TabAPI.navigate({ tabId, url });
  }

  // Tabs
  let tabs = [];
  let activeId = null;

  function renderTabs(){
    tabsEl.innerHTML = "";
    tabs.forEach(t=>{
      const d = document.createElement("div");
      d.className = "tab" + (t.id===activeId ? " active":"");
      d.onclick = ()=>switchTab(t.id);

      d.innerHTML = `
        <span>${escapeHtml(t.title || "Tab")}${t.incognito ? " üï∂Ô∏è" : ""}</span>
        ${t.ip ? `<small>${escapeHtml(t.ip)}</small>` : ""}
        <button class="x" title="Close">√ó</button>
      `;

      d.querySelector(".x").onclick = (ev) => {
        ev.stopPropagation();
        closeTab(t.id);
      };

      tabsEl.appendChild(d);
    });
  }

  function handleTabUpdate(payload){
    if (!payload) return;
    const tab = tabs.find(t => t.id === payload.tabId);
    if (!tab) return;
    if (payload.title) tab.title = payload.title;
    if (payload.url) {
      tab.src = payload.url;
      if (tab.id === activeId) urlInput.value = payload.url;
      window.HIST.add({ url: payload.url, title: tab.title || "" }).catch(() => {});
    }
    renderTabs();
  }

  function switchTab(id){
    activeId = id;
    const tab = getActiveTab();
    if (tab) urlInput.value = tab.src || "";
    window.TabAPI.switch(id);
    renderTabs();
  }

  function closeTab(id){
    const idx = tabs.findIndex(t => t.id === id);
    if (idx === -1) return;

    const wasActive = (id === activeId);
    window.TabAPI.close(id);

    tabs.splice(idx, 1);

    if (!tabs.length){
      onNewTab(false);
      return;
    }

    if (wasActive){
      const next = tabs[Math.max(0, idx-1)];
      if (next) {
        switchTab(next.id);
        return;
      }
    }

    renderTabs();
  }

  function createTab({ incognito=false, url=getHomeUrl() } = {}){
    const id = Date.now() + Math.floor(Math.random()*999);
    const tab = { id, title: "New Tab", src: url, ip: "", incognito };
    tabs.push(tab);
    window.TabAPI.create({ tabId: id, incognito: tab.incognito, url: tab.src });
    switchTab(id);
    return tab;
  }

  // Navigation
  document.getElementById("go").onclick = ()=>{
    const tab = getActiveTab();
    if (!tab) return;
    const u = normalizeUrl(urlInput.value);
    if(!u) return;
    loadUrlInView(tab.id, u);
    tab.src = u;
  };
  urlInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      document.getElementById("go").click();
    }
  });

  document.getElementById("back").onclick = ()=>{ if (activeId) window.TabAPI.back(activeId); };
  document.getElementById("forward").onclick = ()=>{ if (activeId) window.TabAPI.forward(activeId); };
  document.getElementById("reload").onclick = ()=>{ if (activeId) window.TabAPI.reload(activeId); };
  document.getElementById("devtools").onclick = ()=>{ if (activeId) window.TabAPI.devtools(activeId); };
  document.getElementById("home").onclick = ()=>{
    if (!activeId) return;
    loadUrlInView(activeId, getHomeUrl());
  };

  async function onNewTab(incognito){
    const tab = createTab({ incognito: !!incognito, url: getHomeUrl() });

    // 1) get IP from backend
    let info = null;
    try {
      info = await window.AutoIP.getIpForTab(tab.id);
      tab.ip = info.ip || "";
      if (tab.ip) await window.TabAPI.setIp({ tabId: tab.id, ip: tab.ip });
    } catch (e) {
      tab.ip = "";
    }

    // 2) enrich outside browser (GeoLite -> Nominatim)
    let enriched = null;
    try {
      enriched = await window.GeoAPI.enrichIp(tab.ip);
    } catch (e) {
      enriched = { ok:false, error: String(e?.message || e) };
    }

    // 3) store + print list in console
    const entry = { ts: Date.now(), tabId: tab.id, ip: tab.ip, ...enriched };
    logIpGeo(entry);

    renderTabs();
  }

  document.getElementById("newtab").onclick = () => onNewTab(false);
  document.getElementById("newIncog").onclick = () => onNewTab(true);

  // Proxy UI
  const proxyPanel = document.getElementById("proxyPanel");
  const proxyStatusEl = document.getElementById("proxyStatus");
  const proxyDetailsEl = document.getElementById("proxyDetails");
  const proxyTestBtn = document.getElementById("proxyTest");
  let lastProxyTest = null;

  function collectProxyForm(){
    return {
      enabled: document.getElementById("p_enabled").checked,
      scheme: document.getElementById("p_scheme").value,
      host: document.getElementById("p_host").value.trim(),
      port: Number(document.getElementById("p_port").value.trim() || 1080),
      username: document.getElementById("p_user").value,
      password: document.getElementById("p_pass").value,
      bypass: document.getElementById("p_bypass").value.trim()
    };
  }

  function renderProxyStatus(result){
    if (!proxyStatusEl || !proxyDetailsEl) return;
    if (!result){
      proxyStatusEl.className = "status wait";
      proxyStatusEl.textContent = "Not tested";
      proxyDetailsEl.textContent = "";
      return;
    }
    if (result.ok){
      proxyStatusEl.className = "status ok";
      proxyStatusEl.textContent = result.proxy?.enabled ? "Proxy OK" : "Direct OK";
      const location = [result.country, result.cc].filter(Boolean).join(" ");
      const detailParts = [
        result.ip ? `IP ${result.ip}` : null,
        location ? `¬∑ ${location}` : null,
        result.elapsedMs ? `¬∑ ${result.elapsedMs} ms` : null
      ].filter(Boolean);
      proxyDetailsEl.textContent = detailParts.join(" ");
      return;
    }
    proxyStatusEl.className = "status error";
    proxyStatusEl.textContent = "Proxy error";
    proxyDetailsEl.textContent = result.error || "Unknown error";
  }

  async function runProxyTest(){
    if (!proxyTestBtn) return;
    proxyTestBtn.disabled = true;
    proxyStatusEl.className = "status wait";
    proxyStatusEl.textContent = "Testing...";
    proxyDetailsEl.textContent = "";
    try {
      const cfg = collectProxyForm();
      const res = await window.ProxyCtl.test({ proxy: cfg });
      lastProxyTest = { ...res, ts: Date.now() };
      renderProxyStatus(res);
    } catch (e) {
      renderProxyStatus({ ok: false, error: String(e?.message || e) });
    } finally {
      proxyTestBtn.disabled = false;
    }
  }
  const PANEL_GAP = 24;
  let currentTopOffset = 0;

  function hideAllPanels(except){
    document.querySelectorAll(".panel").forEach(panel => {
      if (panel !== except) panel.style.display = "none";
    });
  }

  function getRightInset(){
    const openPanels = Array.from(document.querySelectorAll(".panel"))
      .filter(panel => panel.style.display === "block");
    if (!openPanels.length) return 0;
    const widths = openPanels.map(panel => panel.getBoundingClientRect().width || 0);
    return Math.max(...widths, 0) + PANEL_GAP;
  }

  function getLeftInset(){
    if (!geoPanel) return 0;
    if (window.getComputedStyle(geoPanel).display === "none") return 0;
    const width = geoPanel.getBoundingClientRect().width || 0;
    return width > 0 ? width + PANEL_GAP : 0;
  }

  function updateViewInset(defer = false){
    const apply = () => {
      const rightInset = getRightInset();
      const leftInset = getLeftInset();
      window.TabAPI.resize({ topOffset: currentTopOffset, rightInset, leftInset });
    };
    if (defer) {
      requestAnimationFrame(apply);
    } else {
      apply();
    }
  }

  function togglePanel(panelEl, onOpen){
    const isHidden = window.getComputedStyle(panelEl).display === "none";
    if (isHidden) hideAllPanels(panelEl);
    panelEl.style.display = isHidden ? "block" : "none";
    if (isHidden && onOpen) onOpen();
    updateViewInset(isHidden);
  }

  document.getElementById("proxyBtn").onclick = () => {
    togglePanel(proxyPanel, async () => {
      await loadProxyUIFromConfig();
    });
  };
  document.getElementById("proxyClose").onclick = () => {
    proxyPanel.style.display = "none";
    updateViewInset();
  };

  if (proxyTestBtn) proxyTestBtn.onclick = runProxyTest;

  async function loadProxyUIFromConfig(){
    const cfg = await window.CfgAPI.get();
    const p = cfg.proxy || {};
    document.getElementById("p_enabled").checked = !!p.enabled;
    document.getElementById("p_scheme").value = p.scheme || "socks5";
    document.getElementById("p_host").value = p.host || "";
    document.getElementById("p_port").value = String(p.port || 1080);
    document.getElementById("p_user").value = p.username || "";
    document.getElementById("p_pass").value = p.password || "";
    document.getElementById("p_bypass").value = p.bypass || "";
    renderProxyStatus(lastProxyTest);
  }

  document.getElementById("proxyApply").onclick = async () => {
    const cfg = collectProxyForm();
    await window.ProxyCtl.set(cfg);
    if (activeId) window.TabAPI.reload(activeId);
    await loadProxyUIFromConfig();
    await runProxyTest();
  };

  // User-Agent UI
  const uaPanel = document.getElementById("uaPanel");
  const uaPresetSelect = document.getElementById("ua_preset");

  function renderPresetOptions(){
    uaPresetSelect.innerHTML = "";
    Object.entries(USER_AGENT_PRESETS).forEach(([key, value]) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = `${key} ¬∑ ${value.slice(0, 40)}‚Ä¶`;
      uaPresetSelect.appendChild(opt);
    });
  }

  async function loadUserAgentFromConfig(){
    const cfg = await window.CfgAPI.get();
    UA_CONFIG = cfg.userAgent || UA_CONFIG;
    SETTINGS_CONFIG = cfg.settings || SETTINGS_CONFIG;
    applyTheme(SETTINGS_CONFIG.theme);
    document.getElementById("ua_mode").value = UA_CONFIG.mode || "preset";
    uaPresetSelect.value = UA_CONFIG.preset || "chrome-win";
    document.getElementById("ua_custom").value = UA_CONFIG.custom || "";
    document.getElementById("ua_suffix").value = UA_CONFIG.suffix || "";
    toggleUaInputs();
  }

  function toggleUaInputs(){
    const mode = document.getElementById("ua_mode").value;
    const isCustom = mode === "custom";
    document.getElementById("ua_custom").disabled = !isCustom;
    uaPresetSelect.disabled = isCustom;
  }

  document.getElementById("uaBtn").onclick = () => {
    togglePanel(uaPanel, async () => {
      await loadUserAgentFromConfig();
    });
  };
  document.getElementById("uaClose").onclick = () => {
    uaPanel.style.display = "none";
    updateViewInset();
  };
  document.getElementById("ua_mode").onchange = toggleUaInputs;

  document.getElementById("uaApply").onclick = async () => {
    const payload = {
      mode: document.getElementById("ua_mode").value,
      preset: uaPresetSelect.value,
      custom: document.getElementById("ua_custom").value.trim(),
      suffix: document.getElementById("ua_suffix").value.trim()
    };
    const res = await window.UA.set(payload);
    if (res?.ok) UA_CONFIG = res.userAgent || payload;
    if (activeId) window.TabAPI.reload(activeId);
    await loadUserAgentFromConfig();
  };

  function applyTheme(theme){
    const mode = theme === "dark" ? "dark" : "light";
    document.body.classList.toggle("dark", mode === "dark");
  }

  // Extensions UI
  const extPanel = document.getElementById("extPanel");
  const extList = document.getElementById("extList");
  document.getElementById("extBtn").onclick = () => {
    togglePanel(extPanel, async () => {
      await refreshExtensions();
    });
  };
  document.getElementById("extClose").onclick = () => {
    extPanel.style.display = "none";
    updateViewInset();
  };

  function extCard(item){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="name">${escapeHtml(item.name || "(unknown)")}</div>
      <div class="muted">Path: ${escapeHtml(item.path || "")}</div>
      <div class="muted">ID: ${escapeHtml(item.id || "‚Äî")}</div>
      <div class="actions">
        <label style="margin-right:auto">
          <input type="checkbox" class="extToggle" ${item.enabled ? "checked":""}> Enabled
        </label>
        <button class="extRemove mini">Remove</button>
      </div>
    `;

    div.querySelector(".extToggle").addEventListener("change", async (e) => {
      const enabled = !!e.target.checked;
      const r = await window.ExtAPI.toggle({ path: item.path, enabled });
      if (!r.ok) alert("Toggle failed: " + (r.error || "unknown"));
      await refreshExtensions();
    });

    div.querySelector(".extRemove").addEventListener("click", async () => {
      const ok = confirm("Remove this extension from config and unload it?");
      if (!ok) return;
      await window.ExtAPI.remove({ path: item.path });
      await refreshExtensions();
    });

    return div;
  }

  async function refreshExtensions(){
    extList.innerHTML = "Loading‚Ä¶";
    const r = await window.ExtAPI.list();
    if (!r.ok) { extList.innerHTML = "Failed."; return; }
    extList.innerHTML = "";
    const items = r.configured || [];
    if (!items.length) {
      extList.innerHTML = `<div class="muted">No extensions configured yet. Click ‚ÄúAdd (Folder)‚Äù.</div>`;
      return;
    }
    items.forEach(item => extList.appendChild(extCard(item)));
  }

  document.getElementById("extRefresh").onclick = refreshExtensions;
  document.getElementById("extAdd").onclick = async () => {
    const pick = await window.ExtAPI.pickFolder();
    if (!pick.ok) return;
    const r = await window.ExtAPI.add(pick.path);
    if (!r.ok) alert("Add/load failed: " + (r.error || "unknown"));
    await refreshExtensions();
  };

  // Bookmarks UI + bar
  const bmPanel = document.getElementById("bmPanel");
  const bmList = document.getElementById("bmList");
  document.getElementById("bmBtn").onclick = () => {
    togglePanel(bmPanel, async () => {
      await refreshBookmarks();
    });
  };
  document.getElementById("bmClose").onclick = () => {
    bmPanel.style.display = "none";
    updateViewInset();
  };
  document.getElementById("bmRefresh").onclick = refreshBookmarks;

  function bmCard(b){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="name">${escapeHtml(b.title || "Bookmark")}</div>
      <div class="muted">${escapeHtml(b.url || "")}</div>
      <div class="actions">
        <button class="bmOpen mini">Open</button>
        <button class="bmDel mini">Delete</button>
      </div>
    `;
    div.querySelector(".bmOpen").onclick = () => {
      if (activeId && b.url) loadUrlInView(activeId, b.url);
    };
    div.querySelector(".bmDel").onclick = async () => {
      await window.BM.remove({ url: b.url });
      await refreshBookmarks();
    };
    return div;
  }

  async function refreshBookmarks(){
    const r = await window.BM.list();
    const list = (r.bookmarks || []).slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

    bmList.innerHTML = "";
    if (!list.length) bmList.innerHTML = `<div class="muted">No bookmarks yet.</div>`;
    else list.forEach(b => bmList.appendChild(bmCard(b)));

    bmbarEl.innerHTML = "";
    const top = list.slice(0, 20);
    top.forEach(b => {
      const pill = document.createElement("div");
      pill.className = "bmitem";
      pill.innerHTML = `
        <span>${escapeHtml(b.title || "Bookmark")}</span>
        <button class="del" title="Remove">‚úï</button>
      `;
      pill.onclick = () => {
        if (activeId && b.url) loadUrlInView(activeId, b.url);
      };
      pill.querySelector(".del").onclick = async (ev) => {
        ev.stopPropagation();
        await window.BM.remove({ url: b.url });
        await refreshBookmarks();
      };
      bmbarEl.appendChild(pill);
    });

    if (!top.length) {
      bmbarEl.innerHTML = `<span class="muted">No bookmarks ‚Äî click ‚Äú‚òÖ Add current‚Äù to pin here.</span>`;
    }
  }

  document.getElementById("bmAddCurrent").onclick = async () => {
    const tab = getActiveTab();
    if (!tab?.src) return alert("No URL to bookmark.");
    await window.BM.add({ title: tab.title || "Bookmark", url: tab.src });
    await refreshBookmarks();
  };

  // History UI
  const histPanel = document.getElementById("histPanel");
  const histList = document.getElementById("histList");
  document.getElementById("histBtn").onclick = () => {
    togglePanel(histPanel, async () => {
      await refreshHistory();
    });
  };
  document.getElementById("histClose").onclick = () => {
    histPanel.style.display = "none";
    updateViewInset();
  };
  document.getElementById("histRefresh").onclick = refreshHistory;

  document.getElementById("histClear").onclick = async () => {
    const ok = confirm("Clear all history?");
    if (!ok) return;
    await window.HIST.clear();
    await refreshHistory();
  };

  function timeStr(ts){
    try { return new Date(ts).toLocaleString(); } catch { return ""; }
  }

  function histCard(h){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="name">${escapeHtml(h.title || "(no title)")}</div>
      <div class="muted">${escapeHtml(h.url || "")}</div>
      <div class="muted">${escapeHtml(timeStr(h.ts))}</div>
      <div class="actions">
        <button class="histOpen mini">Open</button>
      </div>
    `;
    div.querySelector(".histOpen").onclick = () => {
      if (activeId && h.url) loadUrlInView(activeId, h.url);
    };
    return div;
  }

  async function refreshHistory(){
    const r = await window.HIST.list();
    const list = (r.history || []).slice().sort((a,b)=> (b.ts||0)-(a.ts||0));
    histList.innerHTML = "";
    if (!list.length) histList.innerHTML = `<div class="muted">No history yet.</div>`;
    else list.forEach(h => histList.appendChild(histCard(h)));
  }

  // Settings UI
  const settingsPanel = document.getElementById("settingsPanel");
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsClose = document.getElementById("settingsClose");
  const settingsApply = document.getElementById("settingsApply");

  async function loadSettingsFromConfig(){
    const cfg = await window.CfgAPI.get();
    SETTINGS_CONFIG = cfg.settings || SETTINGS_CONFIG;
    document.getElementById("s_home").value = SETTINGS_CONFIG.homeUrl || "https://duckduckgo.com";
    document.getElementById("s_search").value = SETTINGS_CONFIG.searchEngine || "duckduckgo";
    document.getElementById("s_theme").value = SETTINGS_CONFIG.theme || "light";
    applyTheme(SETTINGS_CONFIG.theme);
  }

  function collectSettings(){
    return {
      homeUrl: document.getElementById("s_home").value.trim(),
      searchEngine: document.getElementById("s_search").value,
      theme: document.getElementById("s_theme").value
    };
  }

  if (settingsBtn) {
    settingsBtn.onclick = () => {
      togglePanel(settingsPanel, async () => {
        await loadSettingsFromConfig();
      });
    };
  }
  if (settingsClose) {
    settingsClose.onclick = () => {
      settingsPanel.style.display = "none";
      updateViewInset();
    };
  }

  if (settingsApply) {
    settingsApply.onclick = async () => {
      const payload = collectSettings();
      const res = await window.CfgAPI.set(payload);
      if (res?.ok) SETTINGS_CONFIG = res.settings || payload;
      applyTheme(SETTINGS_CONFIG.theme);
      if (activeId) window.TabAPI.reload(activeId);
    };
  }

  // Init
  (async () => {
    renderPresetOptions();
    await loadUserAgentFromConfig();
    await loadSettingsFromConfig();
    window.TabAPI.onUpdate(handleTabUpdate);
    currentTopOffset = Math.round(viewsEl.getBoundingClientRect().top || 0);
    await window.TabAPI.resize({ topOffset: currentTopOffset, rightInset: 0, leftInset: getLeftInset() });
    window.addEventListener("resize", () => {
      currentTopOffset = Math.round(viewsEl.getBoundingClientRect().top || 0);
      updateViewInset();
    });
    await fetchMainBrowserIp();
    await onNewTab(false);
    await refreshBookmarks();
  })();

  document.addEventListener("keydown", (event) => {
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const modKey = isMac ? event.metaKey : event.ctrlKey;
    if (modKey && event.key.toLowerCase() === "l") {
      event.preventDefault();
      urlInput.focus();
      urlInput.select();
    }
  });
</script>
</body>
</html>
